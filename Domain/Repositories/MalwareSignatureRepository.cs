using Domain.Database;
using Domain.Models;
using Microsoft.EntityFrameworkCore;

namespace Domain.Repositories;

public interface IMalwareSignatureRepository : IRepositoryBase<MalwareSignature>
{
    public Task<List<MalwareSignature>> GetAllByScrapingLogTimeAsync(DateTime scrapingLogTime, bool includeDeleted = false);
    public Task<bool> ExistsByHashAsync(string hash);
}

public class MalwareSignatureRepository : RepositoryBase<MalwareSignature>, IMalwareSignatureRepository
{
    public MalwareSignatureRepository(DatabaseContext databaseContext) : base(databaseContext) {}


    public async Task<List<MalwareSignature>> GetAllByScrapingLogTimeAsync(DateTime scrapingLogTime, bool includeDeleted = false)
    {
        return await Get(includeDeleted)
            .Where(s => s.ScrapingLog.Date > scrapingLogTime || s.DeletedAt > scrapingLogTime)
            .ToListAsync();
    }

    public async Task<bool> ExistsByHashAsync(string hash)
    {
        return await Get()
            .AnyAsync(e => e.Signature == hash);
    }
}